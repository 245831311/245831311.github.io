---
title: 视频性能压测
date: 2021-07-22 11:16:39
categories: 
- 视频
tags:
- 视频
---

## 背景
由于项目接入了二千多路摄像头，三十台机器集群，应项目的要求对程序项目进行压测，目标是测试到一台流媒体服务器能同时并发支撑多小路视频，从而推测整个集群的能力，也为以后的扩展。

## 前期准备

- 服务器1台

  配置：CPU 8核,内存 16G
- 客户端1台

  配置：CPU 8核,内存 16G
- 监控服务端工具nmon：
- 压测工具：自研发的一款拉流工具，针对我们视频项目接口定制化开发

- 300个海康摄像头1920×1080P(可用正式环境)

## 压测

在压测的时候我认为需要清楚了解整个网络架构图，这样才能发现哪些地方存在的瓶颈，便于后期针对瓶颈地方进行压测。以下是我大致画出当时项目的网络环境：

![网络架构图](/images/video/压测流程图.png)


经过分析，存在瓶颈：
1. 客户端自研拉流程序m1存在拉流的性能瓶颈
2. 流媒体北向的拉流分发能力m2的瓶颈
3. 流媒体南向的推流能力m3的瓶颈
4. 验证m4出口是否有千兆带宽


### 场景一

场景：多个用户，同时访问1路摄像头视频

目的：测出单台流媒体服务北向分发能力m2的极限。

为了减少自研发的客户端拉流程序瓶颈对本次压力测试造成影响，使用多个客户端进行拉流。  

![场景一](/images/video/压测结果一.png)

结论：160个用户访问同一路摄像头视频时，系统能够稳定工作；北向并发能力达到160以上。

### 场景二

场景：两个客户端分别请求N路不同的视频，共请求2N路视频。每路视频1人观看。

目的：测出单台流媒体服务南向m3能力的极限。

![场景二](/images/video/压测结果二.png)


结论：南向并发处理80路摄像头视频时，系统能够稳定工作；南向并发处理100路摄像头视频时，网络出现较大波动；因此，单个流媒体服务的南向处理能力，为90路视频。


### 场景三

场景：两个客户端，分别请求两个不同的流媒体服务器；每个客户端请求N路视频，共请求2N路视频。

目的：南向交换机性能瓶颈测试。

![场景三](/images/video/压测结果三.png)


结论：单台客户端服务器最高可以处理南向70路视频，
单台流媒体服务器最多可处理南向90路视频。


### 场景四

场景：两个客户端，分别请求一台服务器上的两个流媒体服务；每个客户端请求N路视频，共请求2N路视频。

目的：压测m4出口带宽是否达到千兆瓶颈

![场景四](/images/video/压测结果四.png)

结论：当请求并发90路视频时，单台流媒体服务器系统能够稳定工作，当并发请求100路视频时，网络IO出现较大波动。因此，单台流媒体服务器南向摄像头最多只能处理90路视频

## 总结

其实对于我来说，有幸参与了这次压测的整个过程，其中包括了跟项目组的沟通，跟第三方供应商技术交流等等。其实对于这类压测，最好能确认好控制单一要素，控制单一要素那就需要将每个步骤分层，然后将其余部分当作整体看待。举个例子，要想测试m3南向并发处理能力，那就将m3往下的部分当作整体，将其他没关要素降到影响最低（譬如客户端是瓶颈因素，那就水平扩展客户端），逐步增大压力，观察服务器等指标，如果出现一些业务报错或者其他问题往往就是触发到瓶颈，这个需要根据业务场景来定。由于我们这里偏向于IO密集型，所以一般都是观察网络IO主要是上下行带宽的指标为主。


