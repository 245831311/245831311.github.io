---
title: 选型视频网关
date: 2021-07-23 11:16:39
categories: 
- 视频
tags:
- 视频
---

## 背景

随着发展，视频网关也逐步完善，但后期也出现了越来越多的需求，譬如流控、鉴权、业务分发等功能。这些功能原本是直接放在视频网关上面，但是考虑到以后的易于维护、可扩展性、复用、避免代码臃肿、职责单一的问题，就将这部分功能单独抽到一个api网关上面。这样一来我们接下来首要的问题就是选型了。

## 技术对比

![网关选型对比](/images/video/网关选型图.png)

网关说到底最重要的技术选性格是并发能力，以下是Gateway官网作者做了一个压测

![image](/images/video/网关压测性能对比.png)


这篇文章是我看了那么多对比做得比较清晰简单的一篇：[压测对比](https://www.edjdhbb.com/2018/12/16/%E7%BD%91%E5%85%B3%E9%80%89%E6%8B%A9%E5%9B%B0%E9%9A%BE%E7%97%87/)

### 为什么选择SpringCloud Gateway

选择Gateway，基于以下几点考虑：

1. 维护成本

虽然Kong的并发能力更高，但是Kong比较适合业务相对简单的网关，且公司大多都是JAVA技术人员，对于JAVA技术栈的系统来说维护起来比较困难。举个例子当业务复杂起来时，维护lua的脚本就会越来越多，因此引入一种新的技术栈成本是一个相对较高的事情。

2. 接入快

相比zuul1.x与Gateway，都是可以无缝对接到spring boot或spring cloud,但相比起来Gateway能支持websocket且并发的能力相对高于zuul，而zuul2.x在后续没有整合到spring上。重要一点是，接入到Gateway相对比较快，开发对应的Filter就能满足业务。

3. 内置功能完善

Gateway自带了多种Filter和Router，对于开发一个简单的网关来说是完全足够。像限流之类功能也是需要的。



## SpringCloud Gateway

既然选择了Gateway,我们现在就简单介绍下Gateway的用法，以下是Gateway的框架图：

![Gateway框架](/images/video/gateway网关图.png)

可以看出其实Gateway的架构其实是非常简单。Gateway有几个概念：Route、Predicate与Filter

**Route**
网关配置的基本组成模块，和Zuul的路由配置模块类似。一个Route模块由一个 ID，一个目标 URI，一组断言和一组过滤器定义。如果断言为真，则路由匹配，目标URI会被访问。


**Predicate**

Predicate是一个Java8的函数，输入类型是Spring的ServerWebExchange，允许匹配来自Http的任何内容，如请求头或者参数。

![Predicate功能图](/images/video/gateway断言.png)


**Filter**
使用特定工厂构建的Spring GatewayFilter实例，可以在发生下游请求之前修改请求信息或者响应请求之后修改返回内容（这一点与Zuul的过滤器一致）。

![Filter功能图](/images/video/gateway触发器.png)



## 如何自定义开发Filter

1. 继承AbstractGatewayFilterFactory默认的抽象类,并实现apply的方法

```
/**
 * @description: 替换服务地址过滤器
 * @author: lhj
 * @Date: 2021年1月16日 下午5:00:00
 */
@SuppressWarnings({ "rawtypes" })
public class ProvideServiceGatewayFilterFactory extends AbstractGatewayFilterFactory {
	private static final Logger LOG = LoggerFactory.getLogger(ProvideServiceGatewayFilterFactory.class);
	private CrudService<RuleTransformEntity> ruleService;
	public ProvideServiceGatewayFilterFactory() {
		super();
	}
	public ProvideServiceGatewayFilterFactory(CrudService<RuleTransformEntity> ruleService) {
		super();
		this.ruleService = ruleService;
	}
	@Override
	public GatewayFilter apply(Object config) {
		return (exchange, chain) -> {
			SimpleRespTaskEntity taskEntity = exchange.getAttribute(WebExchangeUtils.RESP_BASE_TASK_ENTITY);
			NetworkNature networkNature = exchange.getAttribute(WebExchangeUtils.NETWORK_TYPE);
			Object startTime = exchange.getAttribute(WebExchangeUtils.START_MILLIS);
			Map<String, String> urls = taskEntity.getUrls();
			urls.entrySet().forEach(entry -> {
				String schemaUrl = entry.getKey();
				String url = entry.getValue();
				try {
					URI uri = URI.create(url);
					String path = uri.getPath();
					String key = url.substring(0, url.indexOf(path)) + "-" + networkNature;
					RuleTransformEntity transform = ruleService.get(key);
					LOG.info("key:{},transform:{}",key,transform);
					if (!Objects.isNull(transform)) {
						String transformUrl = url.replace(transform.getSourcePrefix(), transform.getTargetPrefix());
						urls.put(schemaUrl, transformUrl);
					}
				} catch (Exception e) {
					LOG.error(e.getMessage());
				}
			});
			LOG.info("transform urls:{},spends {} ms", urls,
					System.currentTimeMillis() - Long.parseLong(startTime.toString()));
			return WebfluxUtil.writeResponse(ResponseResult.fromData(taskEntity), exchange.getResponse());
		};
	}
}
```

2. 将这个工厂注入到spring容器当中

```
@Bean
public ProvideServiceGatewayFilterFactory replaceServiceGatewayFilterFactory(CrudService<RuleTransformEntity> ruleTransformManagerService) {
	return new ProvideServiceGatewayFilterFactory(ruleTransformManagerService);
}
```

3. 配置yml文件

```
  cloud:
    gateway:
      routes:
        - id: stream
          uri: http://{server}/mag-cluster-server/
          predicates:
            - Path=/api/video/startTransform/**
            - name: ReadBodyPredicateFactory 
              args:
                inClass: "#{T(String)}"
                predicate: "#{@testRequestBody}"
          filters:
            - ProvideService
```

## 参考
1. [Gateway官方文档](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/)